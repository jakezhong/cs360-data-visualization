<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
		<link href="https://fonts.googleapis.com/css?family=Roboto+Mono%7CArvo:400%7CRoboto:300,400,500,700%7CCookie" rel="stylesheet">
		<link rel="stylesheet" href="../../ui/vendor/css/fontawesome.min.css">
		<link rel="stylesheet" href="../../ui/vendor/perfect-scrollbar.css">
		<link rel="stylesheet" href="../../ui/css/style.css">
		<script src="../../ui/vendor/d3.v5.min.js"></script>
		<title>CS360/560 Data Visualization</title>
	<style>
		.tree-container {
			background-color: rgba(0,150,200,0.1);
			font-size: 0;
		}
		.tree-tooltip {
			min-width: 100px;
			background-color: #fff;
			border-radius: 3px;
			padding: 10px;
			font-size: 13px;
			font-weight: 400;
			fill: black;
			color: black;
			stroke: none;
			text-align: center;
			border: 1px solid black;
		}
		.pack-tooltip {
			background-color: #fff;
			border-radius: 3px;
			padding: 10px;
			font-size: 13px;
			font-weight: 400;
			fill: black;
			color: black;
			stroke: none;
			border: 1px solid black;
		}
		.pack-tooltip table {
			width: 100%;
			text-align: left;
		}
		.pack-tooltip table th {
			font-size: 14px;
		}
		.info-table {
			background-color: rgba(0, 255, 255, 0.5);
			width: 400px;
			color: #000;
		}
		.info-table th {
			white-space: nowrap;
		}
		.info-table tr {
			vertical-align: top;
		}
		.legend-title {
			font-size: 16px;
		}
		.legend-label {
			font-size: 12px;
		}
	</style>
	</head>
	<body>
		<div class="full-page">
			<div class="sidebar-container">
				<aside  class="sidebar sidebar-left sidebar-fixed sidebar-dark">
					<div class="scroll">
						<div class="sidebar-header text-white bg-info">
							<div class="sidebar-brand d-flex justify-content-between align-items-center">
								<div class="title text-truncate">
									Data Visulization
								</div>
								<div class="logo align-items-center justify-content-around">
									<i class="material-icons">all_inclusive</i>
								</div>
							</div>
						</div>
						<div class="sidebar-nav-container">
							<ul class="list-nav sidebar-nav list-nav-dark list-nav-dark-info">
								<li class="list-nav-group-title">
									<span>
									  HOMEWORK 4
									</span>
								</li>
								<li class="list-nav-item">
									<a href="../../" class="list-nav-link">
									  <span class="list-nav-icon">
										<i class="material-icons">home</i>
									  </span>
									  <span class="list-nav-label">Home</span>
									</a>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Homework 1</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework1/overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework1/prototypes.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Tableau Prototypes</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework1/d3-bar.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">D3 Implementations</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework1/requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Homework 2</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework2/overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework2/scatterplot-matrix.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Scatterplot Matrix</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../homework2/requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Homework 3</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="implementation.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Implementations</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Homework 4</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="implementation.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Implementations</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Midterm</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="../midterm/prototype.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Prototype</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../midterm/implementation.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Implementation</span>
										  </a>
										</li>
									</ul>
								</li>
								<li class="list-nav-item">
									<a href="#" class="list-nav-link">
									  	<span class="list-nav-icon">
											<i class="material-icons">folder_open</i>
									  	</span>
									  	<span class="list-nav-label">Final</span>
									  	<span class="list-nav-expand">
											<i class="material-icons">add</i>
									  	</span>
									</a>
									<ul class="list-nav-child">
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/overview.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Overview</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/about.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">About</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/dataset.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Dataset</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/alpha.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Alpha Release</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/beta.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Beta Release</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/final.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Final Release</span>
										  </a>
										</li>
										<li class="list-nav-item list-nav-child-item">
										  <a href="../final/requirements.html" class="list-nav-link">
											<span class="list-nav-icon list-nav-icon-sm">
											  <i class="material-icons">keyboard_arrow_right</i>
											</span>
											<span class="list-nav-label">Requirements</span>
										  </a>
										</li>
									</ul>
								</li>
							</ul>
						</div>
					</div>
				</aside>
			</div>
			<div class="page">
				<div class="topbar-container">
					<nav class="navbar bg-white text-secondary navbar-expand-sm py-0 topbar fixed">
						<button class="btn btn-flat-secondary btn-sm btn-icon mr-1 no-shadow d-none d-xl-block sidebar-toggle">
							<i class="material-icons">menu</i>
						</button>
						<button class="btn btn-flat-secondary btn-sm btn-icon mr-1 d-xl-none no-shadow sidebar-hide">
							<i class="material-icons">menu</i>
						</button>

						<div class="navbar-text ml-3 d-none d-sm-block">
							<h5 class="m-0 text-dark">Homework 4</h5>
						</div>

						<div class="ml-auto d-sm-flex ml-3">
							<ul class="navbar-nav">
								<li class="nav-item no-caret">
									<a href="../about.html" class="nav-link text-center">About</a>
								</li>
								<li class="nav-item no-caret">
									<a href="../resources.html" class="nav-link text-center">Resources</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://jakezhong.com" target="_blank" class="nav-link text-center">
										<i class="far fa-globe"></i>
									</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://github.com/jakezhong" target="_blank" class="nav-link text-center">
										<i class="fab fa-github"></i>
									</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://www.linkedin.com/in/jake-zhong/" target="_blank" class="nav-link text-center">
										<i class="fab fa-linkedin-in"></i>
									</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://www.instagram.com/jakezhong_" target="_blank" class="nav-link text-center">
										<i class="fab fa-instagram"></i>
									</a>
								</li>
								<li class="nav-item no-caret">
									<a href="https://www.facebook.com/jksakura" target="_blank" class="nav-link text-center">
										<i class="fab fa-facebook"></i>
									</a>
								</li>
							</ul>
						</div>
					</nav>
				</div>
				<div class="page-content">
					<section class="section">
						<div class="container">
							<h1 class="section-title">Homework 4 Implementation</h1>
						  	<!-- Begin page content -->
						  	<div class="content">
								<hr class="space"/>
								<h3 class="section-title">Data Encoding</h3>
								<ul>
									<li>
										<p><b>Basemap: </b>Neighborhoods of SF area</p>
									</li>
									<li>
										<p><b>Color/Legend: </b>Range of case numbers</p>
									</li>
									<li>
										<p><b>Circle: </b>Individual case</p>
									</li>
									<li>
										<p><b>Tooltip: </b>Neighborhood information</p>
									</li>
									<li>
										<p><b>Detail Panel: </b>Case information</p>
									</li>
								</ul>
								<hr class="space"/>
								<h3 class="section-title top-space">Interactivity Guide</h3>
								<h4 class="section-title top-space">Tooltip</h4>
								<figure>
									<p><img src="../../assets/img/homework3/interactivity1.gif" alt=""></p>
									<figcaption>Hovering on a map's block will display a tooltip box and it will follow the user's mouse cursor.</figcaption>
								</figure>
								<h4 class="section-title top-space">Detail Panel</h4>
								<figure>
									<p><img src="../../assets/img/homework3/interactivity2.gif" alt=""></p>
									<figcaption>Hovering on a map's circle will display a detail panel on the top-left corner of the map.</figcaption>
								</figure>
								<h4 class="section-title top-space">Zooming</h4>
								<figure>
									<p><img src="../../assets/img/homework3/interactivity3.gif" alt=""></p>
									<figcaption>Zooming can be done by scrolling down or up on the map.</figcaption>
								</figure>
								<h4 class="section-title top-space">Dragging</h4>
								<figure>
									<p><img src="../../assets/img/homework3/interactivity4.gif" alt=""></p>
									<figcaption>Pressing and moving the mouse on the map at the same time can drag the map around.</figcaption>
								</figure>
								<hr class="space"/>
								<h3 class="section-title">Data Wrangling</h3>
								<h4 class="section-title">API Request Filter</h4>
								<p>I adjusted the SQL for the API request in order to only fetched the data of the category "Parking Enforcement" in February 2020.</p>
								<script src="https://gist.github.com/jakezhong/085eeca6b8f4c24c4dd1629ec533d83d.js"></script>
								<h4 class="section-title">Accumulation for neighborhood's case numbers</h4>
								<p>In the original dataset, each neighborhood doesnâ€™t have an accumulation of the case numbers, so I read all the cases and plus the number by the neighborhood in their properties. Here I use a set to avoid duplication and afterward, I convert the set to an array, which is more friendly for d3 implementation.</p>
								<script src="https://gist.github.com/jakezhong/5d759d74f2ec9a6aee38b1b4373a04f2.js"></script>
								<hr class="space"/>
								<h3 class="section-title">Conclusion</h3>
								<ul>
									<li>Among all neighborhoods, the largest case number is 82 and the smallest case number is 0 in February 2020.</li>
									<li>Most of the neighborhoods in the SF area see a very small number of cases, from 0 - 10. While a few neighborhoods have many more case numbers, for example, Mission has 82 and Outer Richmond has 68 cases in February 2020.</li>
									<li>Among all the cases, by the date I fetched, most of them are already closed, and there are only about 10 opened cases in total in the SF area in February 2020.</li>
								</ul>
								<hr class="space"/>
								<h3 class="section-title">Attribution</h3>
									<p>For this project, I referred some D3 examples, such as non-proportional symbol map from our lab exercise, legend, color scale and zooming interactivity on the web.</p>
									<h4 class="section-title top-space">References</h4>
									<p>
										<a href="https://www.d3-graph-gallery.com/graph/custom_legend.html" target="_blank">D3 Graph Gallery: D3 Legend Example</a><br/>
										<a href="https://bl.ocks.org/mbostock/8fadc5ac9c2a9e7c5ba2" target="_blank">Map Pan & Zoom I</a><br/>
										<a href="https://bl.ocks.org/hepplerj/f2f4e5f4a9321428b11614674c741177" target="_blank">Threshold scale</a><br/>
										<a href="https://observablehq.com/@d3/color-schemes" target="_blank">Color Schemes</a>
									</p>
								<hr class="space"/>
								<h3 class="section-title">D3 Implementation</h3>
								<div class="card work-images">
									<div class="card-body card-body-p">
									  	<div class="chart-container">
									  		<div class="implementation-container">
												<svg id="tree-container">
													<g id="tree"></g>
													<g id="tooltip" pointer-events="none"></g>
													<g id="details" pointer-events="none"></g>
													<g id="legend" pointer-events="none"></g>
												</svg>
												<svg id="pack-container">
													<g id="pack"></g>
													<g id="tooltip-pack" pointer-events="none"></g>
													<g id="details-pack" pointer-events="none"></g>
													<g id="legend-pack" pointer-events="none"></g>
												</svg>
									  		</div>
									  	</div>
									</div>
								</div>
					  		</div>
						  <!-- End page content -->
						</div>
					</section>
				</div>
			</div>
		</div>
		<script src="https://d3js.org/d3-hierarchy.v1.min.js"></script>
		<script>
			const url = "https://data.sfgov.org/resource/nuek-vuh3.json";
			
			// Data wrangling
			let data = {
				"name": "Fire Department",
				"number": 0,
				"children": []
			};
			
			let callTypes = [];
				
			let colorScale;
			
			// Data loading and wrangling
			d3.json(url).then(function(json) {
//				console.log(json);
//				neighborhoods_analysis_boundaries
//				call_type
				json.forEach(function(d) {
					
					data.number = data.number + 1;

					if (callTypes.indexOf(d.call_type) < 0) {
						callTypes.push(d.call_type);
					}

					let neighborhoods = data.children.map(function(neighborhood) {
						return neighborhood.name;
					});
					
					let indexN = neighborhoods.indexOf(d.neighborhoods_analysis_boundaries);
					
					if (indexN > -1) {
					
						data.children[indexN].number = data.children[indexN].number + 1;
						
						let types = data.children[indexN].children.map(function(type) {
							return type.name;
						});

						let indexT = types.indexOf(d.call_type);

						if (indexT > -1) {
							data.children[indexN].children[indexT].number = data.children[indexN].children[indexT].number + 1;
						} else {
							let newType = {
								"name": d.call_type,
								"number": 1
							}
							
							data.children[indexN].children.push(newType);
						}
					} else {
						let newType = {
							"name": d.call_type,
							"number": 1
						}

						let newNeighborhood = {
							"name": d.neighborhoods_analysis_boundaries,
							"number": 1,
							"children": [newType]
						}

						data.children.push(newNeighborhood);
					}
				});
//				console.log(data);
//				console.log(callTypes);
				
				// Draw tree
				drawTree(data);
				
				drawPack(data);
			});
			
			function tree(data) {
				// Draw svg
				let width = 960;
				let height = 1600;
				const root = d3.hierarchy(data);
				
				root.dx = 10;
				root.dy = width / (root.height + 1);
				
				return d3.tree().nodeSize([root.dx, root.dy])(root);
			}
			
			function drawTree(data) {
				// Draw svg
				let width = 960;
				let height = 1600;
				
				const svg = d3
					.select(".implementation-container")
					.select("svg#tree-container")
					.attr("x", 0)
					.attr("width", width)
					.attr("height", height);
				
				// Initialize color scale
				colorScale = d3
				.scaleOrdinal()
				.domain(callTypes)
				.range(["#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#a6cee3","#b15928"]);
				
				// Draw g
				const g = {
					tree: svg.select("g#tree"),
					tooltip: svg.select("g#tooltip"),
					details: svg.select("g#details"),
					legend: svg.select("g#legend")
				};

//				 setup tooltip (shows neighborhood name)
				const tip = g
					.tooltip
					.append("foreignObject")
					.attr("class", "tree-tooltip");

				tip.attr("text-anchor", "end");
				tip.attr("dx", 0);
				tip.attr("dy", 0);
				tip.attr("width", 250);
				tip.attr("height", 60);
				tip.style("visibility", "hidden");
				
				// Draw tree
				const root = tree(data);
				
				let x0 = Infinity;
				let x1 = -x0;
				
				root.each(d => {
					if (d.x > x1) x1 = d.x;
					if (d.x < x0) x0 = d.x;
				});

				svg.attr("viewBox", [0, 0, width, x1 - x0 + root.dx * 2]);

				g.tree
					.attr("font-family", "sans-serif")
					.attr("font-size", 10)
					.attr("transform", `translate(${root.dy / 3},${root.dx - x0})`);

				const link = g.tree.append("g")
					.attr("fill", "none")
					.attr("stroke", "#555")
					.attr("stroke-opacity", 0.4)
					.attr("stroke-width", 1.5)
					.selectAll("path")
					.data(root.links())
					.join("path")
					.attr("d", d3.linkHorizontal()
						.x(d => d.y)
						.y(d => d.x));

				const node = g.tree.append("g")
					.attr("stroke-linejoin", "round")
					.attr("stroke-width", 3)
					.selectAll("g")
					.data(root.descendants())
					.join("g")
					.attr("transform", d => `translate(${d.y},${d.x})`);

				node.append("circle")
//					.attr("fill", d => d.children ? "#555" : "#999")
					.attr("fill", function(d) {
						if (callTypes.indexOf(d.data.name) > -1) {
							return colorScale(d.data.name);
						} else {
							return d.children ? "#555" : "#999";
						}
					})
					.attr("r", 3);

				node.append("text")
					.attr("dy", "0.31em")
					.attr("x", d => d.children ? -10 : 10)
					.attr("text-anchor", d => d.children ? "end" : "start")
					.text(d => d.data.name)
//					.clone(true).lower()
					.style("fill", function(d) {
						if (callTypes.indexOf(d.data.name) > -1) {
							return colorScale(d.data.name);
						}
					});

//			  // add tooltip
				node.on("mouseover", function(d) {
					console.log(d);
					let html = d.data.name;
					html += "<br># of calls: " + d.data.number;

					tip.html(html);
					tip.style("visibility", "visible");
					tip.attr("x", d.y);
					tip.attr("y", d.x + 660);
					tip.style("color", function() {
						if (callTypes.indexOf(d.data.name) > -1) {
							return colorScale(d.data.name);
						}
					});
				})
				.on("mouseout", function(d) {
					tip.style("visibility", "hidden");
				});
				
				drawTreeLegend(svg);
				
  				return g.tree.node();
			}
			
			function drawTreeLegend(svg) {
				let legend_size = 12;

				// Add one dot in the legend for each name.

				svg.selectAll("legend-rects")
					.data(callTypes)
					.enter()
					.append("rect")
					.attr("x", 0)
					.attr("y", function(d,i){ return i * (legend_size+5) - 60})
					.attr("width", legend_size)
					.attr("height", legend_size)
					.attr("class", "legend-rect")
					.style("fill", function(d) { return colorScale(d); });

				// Add one dot in the legend for each name.
				svg.selectAll("legend-labels")
					.data(callTypes)
					.enter()
					.append("text")
					.attr("x", legend_size * 1.5)
					.attr("y", function(d,i){ return i * (legend_size+5) + (legend_size/2) - 60})
					.text(function(d){ return d; })
					.attr("text-anchor", "left")
					.style("alignment-baseline", "middle")
					.attr("class", "legend-label")
					.style("fill", function(d) { return colorScale(d); });

			}
			
			function pack(data) {
				// Draw svg
				let width = 960;
				let height = 960;
				
				let pack = d3
					.pack()
					.size([width, height])
					.padding(3)
					(d3.hierarchy(data)
					.sum(d => d.number)
					.sort((a, b) => b.number - a.number));
				
				return pack;
				
			}
			
			function drawPack(data) {
				// Draw svg
				let width = 960;
				let height = 960;
				
				const svg = d3
					.select(".implementation-container")
					.select("svg#pack-container")
					.attr("x", 0)
					.attr("width", width)
					.attr("height", height);
				
				let color = d3.scaleLinear()
					.domain([0, 1, 2])
//					.range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
					.range(["#142e57", "#ff4040"])
					.interpolate(d3.interpolateHcl)
//				["#ffffb2","#fecc5c","#fd8d3c","#e31a1c"]
//				["#ff4040","#40ff40","#4040ff","#ff4040"]
//				["#23171b","#2ee5ae","#feb927","#900c00"]
//				["#6e40aa","#2f96e0","#28ea8d","#aff05b"]
//				["#440154","#31688e","#35b779","#fde7`25"]
//				["#ffffb2","#fecc5c","#fd8d3c","#e31a1c"]
//				["#eff3ff","#bdd7e7","#6baed6","#2171b5"]
//				["#002051","#575c6e","#a49d78","#fdea45"]
				
				
				// Draw g
				const g = {
					pack: svg.select("g#pack"),
					tooltip: svg.select("g#tooltip-pack"),
					details: svg.select("g#details-pack"),
					legend: svg.select("g#legend-pack")
				};

//				 setup tooltip (shows neighborhood name)
				const tip = g
					.tooltip
					.append("foreignObject")
					.attr("class", "pack-tooltip");

				tip.attr("text-anchor", "end");
				tip.attr("dx", 0);
				tip.attr("dy", 0);
				tip.attr("width", 250);
				tip.attr("height", 170);
				tip.style("visibility", "hidden");
				
				const root = pack(data);
				let focus = root;
				let view;
				
				svg.attr("viewBox", `-${width / 2} -${height / 2} ${width} ${height}`)
					.style("display", "block")
					.style("margin", "0 -14px")
					.style("background", color(0))
					.style("cursor", "pointer")
					.on("click", () => zoom(root));

				const node = g.pack.append("g")
					.selectAll("circle")
					.data(root.descendants().slice(1))
					.join("circle")
					.attr("fill", d => d.children ? color(d.depth) : "#ffffb2")
					.attr("pointer-events", d => !d.children ? "none" : null)
					.on("mouseover", function(d) {
						d3.select(this).attr("stroke", "#fff");
						
						console.log(d);
						let html = "<table>";
						html += "<tr><th>" + d.data.name + "</th><th>" + d.data.number + "</th></tr>";
						if (d.children.length > 0) {
							d.children.forEach(function(el) {
	//							console.log(el);
								html += "<tr><td>" + el.data.name + "</td><td>" + el.data.number + "</td></tr>";
							});
						}
						html += "</table>";
						tip.html(html);
						tip.style("visibility", "visible");
						tip.attr("x", d.x - 605);
						tip.attr("y", d.y - 540);
					})
					.on("mouseout", function() {
						d3.select(this).attr("stroke", null);
						tip.style("visibility", "hidden");
					})
					.on("click", d => focus !== d && (zoom(d), d3.event.stopPropagation()));

				const label = g.pack.append("g")
					.style("font", "10px sans-serif")
					.attr("pointer-events", "none")
					.attr("text-anchor", "middle")
					.selectAll("text")
					.data(root.descendants())
					.join("text")
					.style("fill-opacity", d => d.parent === root ? 1 : 0)
					.style("display", d => d.parent === root ? "inline" : "none")
					.text(d => d.data.name);
				
//				console.log(root);
				
				zoomTo([root.x, root.y, root.r * 2]);

				function zoomTo(v) {
					const k = width / v[2];

					view = v;
					
					label.attr("transform", function(d) {
						
						return `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`
					});
					node.attr("transform", function(d) {
						
						return `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`;
					});
					node.attr("r", function(d) {
						
						return d.r * k;
					});
				}

				function zoom(d) {
					const focus0 = focus;

					focus = d;

					const transition = svg.transition()
						.duration(d3.event.altKey ? 7500 : 750)
						.tween("zoom", d => {
							const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);
							return t => zoomTo(i(t));
						});

					label
						.filter(function(d) { return d.parent === focus || this.style.display === "inline"; })
						.transition(transition)
						.style("fill-opacity", d => d.parent === focus ? 1 : 0)
						.on("start", function(d) { if (d.parent === focus) this.style.display = "inline"; })
						.on("end", function(d) { if (d.parent !== focus) this.style.display = "none"; });
				}

				return svg.node();
			}
//
//			function drawBasemap(json) {
//			  console.log("basemap", json);
//			
//			  const basemap = g.basemap.selectAll("path.land")
//				.data(json.features)
//				.enter()
//				.append("path")
//				.attr("d", path)
//				.attr("class", "land")
//    			.attr("transform", "translate(0," + 100 + ")")
//			    .attr("fill", function(d) {
//				  if (neighborhoods_set.get(d.properties.name)) {
//					  d.number = neighborhoods_set.get(d.properties.name).number;
//				  } else {
//					  d.number = 0;
//				  }
//				  return colorScale(d.number);
//			    });
//
////			  console.table(neighborhoods_set);
//				
//			  const outline = g.outline.selectAll("path.neighborhood")
//				  .data(json.features)
//				  .enter()
//				  .append("path")
//				  .attr("d", path)
//				  .attr("class", "neighborhood")
//    			  .attr("transform", "translate(0," + 100 + ")")
//				  .each(function(d) {
//					// save selection in data for interactivity
//					// saves search time finding the right outline later
//					d.properties.outline = this;
//				  });
//
//			  // add highlight
//			  basemap.on("mouseover.highlight", function(d) {
//				d3.select(d.properties.outline).raise();
//				d3.select(d.properties.outline).classed("active", true);
//			  })
//			  .on("mouseout.highlight", function(d) {
//				d3.select(d.properties.outline).classed("active", false);
//			  });
//
//			  // add tooltip
//			  basemap.on("mouseover.tooltip", function(d) {
//				let html = d.properties.name;
//					html += "<br># of cases: " + d.number;
//				  
//				tip.html(html);
//				tip.style("visibility", "visible");
//			  })
//			  .on("mousemove.tooltip", function(d) {
//				const coords = d3.mouse(g.basemap.node());
//				tip.attr("x", coords[0] - 100);
//				tip.attr("y", coords[1] - 65);
//			  })
//			  .on("mouseout.tooltip", function(d) {
//				tip.style("visibility", "hidden");
//			  });
//			}
//			
//			// initialize a neighborhood list and store its case number
//			function fillNeighborhood(json) {
//				json.forEach(function(neighborhood) {
//					let name = neighborhood.neighborhoods_sffind_boundaries;
//					if (neighborhoods_set.has(name)) {
//						neighborhoods_set.get(name).number += 1;
//					} else {
//						neighborhoods_set.set(name, {name: name, number: 1});
//					}
//				});
//				
//				neighborhoods_set.each(function(e) {
//					neighborhoods.push([e.name, e.number]);
//				});
//				
//				color_max = d3.max(neighborhoods.map(function(d) {
//					return d[1];
//				}));
//				
//				color_max = Math.ceil(color_max/100)*100;
//				
//				for (let i = 1; i < 6; i++) {
//					color_range.push(i * color_max/5);
//				}
//				
//				colorScale = d3.scaleThreshold()
//				.domain(color_range)
//		  		.range(["#fff1de", "#fdd5a4", "#f88457", "#e55037", "#8e0000"]);
//			}
//			
//			function drawStreets(json) {
//			  console.log("streets", json);
//
//			  // only show active streets
//			  const streets = json.features.filter(function(d) {
//				return d.properties.active;
//			  });
//
//			  console.log("removed", json.features.length - streets.length, "inactive streets");
//
//			  g.streets.selectAll("path.street")
//				.data(streets)
//				.enter()
//				.append("path")
//				.attr("d", path)
//    			.attr("transform", "translate(0," + 100 + ")")
//				.attr("class", "street");
//			}
//						
//			function drawCases(json) {
//			  console.log("cases", json);
//
//			  // loop through and add projected (x, y) coordinates
//			  // (just makes our d3 code a bit more simple later)
//			  json.forEach(function(d) {
//				const latitude = parseFloat(d.lat);
//				const longitude = parseFloat(d.long);
//				const pixels = projection([longitude, latitude]);
//
//				d.x = pixels[0];
//				d.y = pixels[1];
//			  });
//
//			  const symbols = g.cases.selectAll("circle")
//				.data(json)
//				.enter()
//				.append("circle")
//				.attr("cx", d => d.x)
//				.attr("cy", d => d.y)
//				.attr("r", 5)
//			  	.style("stroke", 1)
//				.attr("class", "symbol")
//    			.attr("transform", "translate(0," + 100 + ")")
//				.attr("fill", function(d) {
//				  if (d.status_description != "Closed") {
//					return "red";
//				  }
//				  return;
//				});
//				
//			  symbols.on("mouseover", function(d) {
//				d3.select(this).raise();
//				d3.select(this).classed("active", true);
//
//				// use template literal for the detail table
//				// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals
//			  	let formatDate = d3.timeFormat("%B %d, %Y");
//				  
//				const html = `
//				  <table class="info-table" border="0" cellspacing="0" cellpadding="2">
//				  <tbody>
//					<tr>
//					  <th>Service Name:</th>
//					  <td>${d.service_name}</td>
//					</tr>
//					<tr>
//					  <th>Date:</th>
//					  <td>${formatDate(new Date(d.requested_datetime))}</td>
//					</tr>
//					<tr>
//					  <th>Neighborhood:</th>
//					  <td>${d.neighborhoods_sffind_boundaries}</td>
//					</tr>
//					<tr>
//					  <th>Vehicle Details:</th>
//					  <td>${d.service_details}</td>
//					</tr>
//					<tr>
//					  <th>Status:</th>
//					  <td>${d.status_description}</td>
//					</tr>
//					<tr>
//					  <th>Description:</th>
//					  <td>${d.status_notes}</td>
//					</tr>
//				  </tbody>
//				  </table>
//				`;
//
//				body.html(html);
//				details.style("visibility", "visible");
//			  });
//
//			  symbols.on("mouseout", function(d) {
//				d3.select(this).classed("active", false);
//				details.style("visibility", "hidden");
//			  });
//			}

//			
//			// Zooming for the bars
//			const extent = [0, [width, height]];
//
//			svg.call(d3.zoom()
//			.scaleExtent([1, 4])
//			.extent([[0, 0], [width, height]])
//			.on("zoom", zoomed));
//
//			function zoomed() {
//				g.basemap.selectAll("path.land").attr('transform', d3.event.transform);
//				g.outline.selectAll("path.neighborhood").attr('transform', d3.event.transform);
//			  	g.streets.selectAll("path.street").attr('transform', d3.event.transform);
//				g.cases.selectAll("circle")
//					.attr('transform', d3.event.transform)
//					.attr("r", 5/d3.event.transform.k)
//					.style("stroke-width", 1/d3.event.transform.k);
//			}
		</script>
		<script src="../../ui/vendor/jquery.min.js"></script>
		<script src="../../ui/vendor/popper.min.js"></script>
		<script src="../../ui/vendor/bootstrap.min.js"></script>
		<script src="../../ui/vendor/perfect-scrollbar.min.js"></script>
		<script src="../../ui/vendor/hammer.min.js"></script>
		<script src="../../ui/vendor/jquery-ui/jquery-ui.min.js"></script>
		<script src="../../ui/vendor/color/color.min.js"></script>
		<script src="../../ui/vendor/fontawesome.min.js"></script>
		<script src="../../ui/scripts/sidebar.min.js"></script>
		<script src="../../ui/scripts/collapsible-nav.min.js"></script>
		<script src="../../ui/scripts/colors.min.js"></script>
		<script src="../../ui/scripts/settings.min.js"></script>
		<script src="../../ui/scripts/card.min.js"></script>
		<script src="../../ui/scripts/script.js"></script>
	</body>
</html>
